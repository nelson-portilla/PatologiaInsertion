# -*- coding: utf-8 -*-
import os,sys
reload(sys)
sys.setdefaultencoding('utf8')
import codecs
global informe, lista, jsonDatos, switch, dataMacro, dataMicro, dataDiag
from HTMLParser import HTMLParser
informe=""
lista=[]
switch=0
dataDiag=dataMicro=dataMacro=""
jsonDatos= {'NumeroRegistro':"",
			'HistoriaClinica': "",
			'DescMacro':"",
			'DescMicro':"",
			'DescDiagnostico':""
			}

#Clase para leer el html, se obtienen solo el Data, se limpia y se arma la lista.
class LecturaHTML(HTMLParser):
        def handle_data(self, data):        	
        	global switch, dataMacro, dataMicro, dataDiag

        	data=data.replace('\r\n',"").replace("\t", "").replace("\n", " ").strip()
        	

        	if data!="":
        		print "DaTos-->",data

	        	if data=='DESCRIPCION MACROSCOPICA':
	        		print "macros"
	        		switch=1
	        		print switch

	        	if data=='DESCRIPCION MICROSCOPICA':
	        		switch=2
	        		
	        	if data=='DIAGNOSTICO:':
	        		switch=3        		

	        	if switch==0:
	        		print "agrego en lista"
	        		lista.append(data)
				
				if switch==1:
					print "almaceno en macro"
					dataMacro+=" "+data

	        	if switch==2:
	        		print "almaceno en micro"
	        		dataMicro+=" "+data

	        	if switch==3:
	        		print "Agrego en 3"
	        		#CODIGO PARA PARADA, Analizar TM33464 M7387
	        		if any(char.isdigit() for char in data[:2]):
	        			print "ENTRO-->:", data
	        			switch=4
	        		else:
	        			dataDiag+=" "+data

	        	else:
	        		print "SINO"
	        		


        	# if((data.replace('\r\n',"")).replace("\t", "").replace("\n", " ")!=""):
        	# 	lista.append(data.strip())

        
def ArmarJson():
	global lista, jsonDatos, dataMacro, dataMicro, dataDiag
	
	#Se limpia el texto, se eliminan saltos de linea y espacios.
	dataMacro=dataMacro.strip().replace("\r\n"," ").replace("  ", "")
	dataMicro=dataMicro.strip().replace("\r\n"," ").replace("  ", "")
	dataDiag=dataDiag.strip().replace("\r\n"," ").replace("  ", "")
	
	jsonDatos['NumeroRegistro']=lista[0].replace(".txt", "")
	jsonDatos['HistoriaClinica']=lista[1]
	# jsonDatos['DescMacro']=lista[7]
	# jsonDatos['DescMicro']=lista[9]
	# jsonDatos['DescDiagnostico']=lista[11]
	
	#Se Agregan al diccionario Eliminando el titulo "Desc Macro...", etc.
	jsonDatos['DescMacro']=dataMacro[24:]
	jsonDatos['DescMicro']=dataMicro[24:]
	jsonDatos['DescDiagnostico']=dataDiag[12:]
	
	print "NR..>",jsonDatos['NumeroRegistro']
	print "HC..>",jsonDatos['HistoriaClinica']
	print "MACRO..>",jsonDatos['DescMacro']
	print "MiCRO..>",jsonDatos['DescMicro']
	print "Diag..>",jsonDatos['DescDiagnostico']
	
	# print jsonDatos		
			
#Se obtiene el numero de registro
def getNumeroRegistro():
	return jsonDatos['NumeroRegistro']

#Se Obtiene la descripcion macroscopica
def getMacro():
	return jsonDatos['DescMacro']

#Se Obtiene la descripcion microscopica
def getMicro():
	return jsonDatos['DescMicro']

#Se Obtiene la descripcion diagnostico
def getDiagnostico():
	return jsonDatos['DescDiagnostico']

#Se Obtiene la Historia Clinica
def getHistoriaClinica():
	return jsonDatos['HistoriaClinica']

#Se obtiene el id del paciente de acuerdo a la historia clinica
def getId_Paciente():
	hc=getHistoriaClinica()	
	csv=os.popen("echo | psql -U postgres -h localhost -d patologiaHUV -c 'select p.id from paciente as p where hc="+hc+";'").read().split()
	return csv[2]

#se obtiene el id de la tabla Muestra
def getId_Muestra():
	idpac=getId_Paciente()
	csv=os.popen("echo | psql -U postgres -h localhost -d patologiaHUV -c 'select id from muestra  where idpaciente="+idpac+";'").read().split()
	return csv[2]

def getHTML():
	return informe

#Se abre el archivo y se almacena el contenido
def leerArchivo(ruta):
	global informe
	informe=open(ruta, 'r').read()
	return informe


if __name__ == '__main__':
	None
